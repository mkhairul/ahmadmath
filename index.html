<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Quiz & Practice App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Domine:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Fredoka', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      position: relative;
      overflow: hidden;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .bubble-text {
      font-family: 'Domine', serif;
      text-shadow: 3px 3px 0px rgba(255, 255, 255, 0.3),
                   -1px -1px 0px rgba(0, 0, 0, 0.1);
    }
    
    /* Falling numbers animation */
    .falling-numbers {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .number {
      position: absolute;
      font-size: 2rem;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.15);
      animation: fall linear infinite;
      transform: skewY(-10deg);
    }
    
    @keyframes fall {
      0% {
        top: -10%;
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        top: 110%;
        opacity: 0;
      }
    }
    
    .content-wrapper {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body class="min-h-screen p-4">
  <!-- Falling Numbers Background -->
  <div class="falling-numbers" id="fallingNumbers"></div>
  
  <div class="max-w-4xl mx-auto content-wrapper">
    <!-- Header -->
    <header id="appHeader" class="text-center mb-8">
      <h1 class="text-5xl sm:text-6xl font-bold mb-2 bubble-text" style="color: #FFD700; -webkit-text-stroke: 2px #FF6B9D;">
        Math Practice Time!
      </h1>
      <p class="text-xl text-white font-semibold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Let's practice and have fun!</p>
    </header>

    <!-- Mode Selection -->
    <div id="modeSelection" class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Select Mode</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onclick="showFreeform()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg transition">
          üé® Writing
        </button>
        <button onclick="showQuizSetup()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 px-6 rounded-lg transition">
          üìù Quiz
        </button>
      </div>
    </div>

    <!-- Freeform Mode -->
    <div id="freeformMode" class="hidden bg-white sm:rounded-lg sm:shadow-lg sm:p-6 h-dvh flex flex-col">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 sm:mb-4 gap-2 p-4 sm:p-0 flex-shrink-0">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">Writing Practice</h2>
        <button onclick="backToMenu()" class="text-gray-600 hover:text-gray-800 px-3 py-1 hover:bg-gray-100 rounded">‚Üê Back</button>
      </div>
      
      <!-- Stopwatch (Desktop Only) -->
      <div class="bg-gray-100 rounded-lg p-3 sm:p-4 mb-4 text-center hidden sm:block flex-shrink-0">
        <div class="text-3xl sm:text-4xl font-mono font-bold text-gray-800 mb-3" id="freeformTimer">00:00:00</div>
        <div class="flex flex-wrap justify-center gap-2">
          <button id="freeformStartBtn" onclick="startFreeformTimer()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 sm:px-8 rounded-lg transition min-w-[100px] touch-manipulation">
            Start
          </button>
          <button id="freeformStopBtn" onclick="stopFreeformTimer()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 sm:px-8 rounded-lg transition min-w-[100px] touch-manipulation" disabled>
            Stop
          </button>
          <button onclick="resetFreeformTimer()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 sm:px-8 rounded-lg transition min-w-[100px] touch-manipulation">
            Reset
          </button>
        </div>
      </div>


      <!-- Floating Timer (appears when timer is running) -->
      <div id="floatingTimer" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-40 opacity-80">
        <div class="text-2xl font-mono font-bold" id="floatingTimerDisplay">00:00:00</div>
      </div>

      <!-- Canvas -->
      <div class="border-0 sm:border-4 border-gray-300 sm:rounded-lg overflow-hidden touch-none flex-1 flex">
        <canvas id="freeformCanvas" width="800" height="500" class="w-full h-full cursor-crosshair bg-white" style="touch-action: none;"></canvas>
      </div>
      
      <!-- Desktop Controls -->
      <div class="mt-4 flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 hidden sm:flex">
        <div class="flex gap-2 order-2 sm:order-1">
          <button onclick="saveCanvas()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition touch-manipulation">
            Save
          </button>
          <button onclick="clearCanvas()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition touch-manipulation">
            Clear Canvas
          </button>
        </div>
        <div class="flex items-center justify-between sm:justify-end gap-3 order-1 sm:order-2">
          <label class="text-gray-700 font-semibold text-sm sm:text-base">Brush Size:</label>
          <input type="range" id="brushSize" min="1" max="10" value="3" class="flex-1 sm:w-32 h-8 sm:h-auto">
          <span id="brushSizeValue" class="text-gray-700 font-mono font-bold min-w-[2ch] text-center">3</span>
        </div>
      </div>

      <!-- Mobile FAB -->
      <button onclick="toggleMobileControls()" class="sm:hidden fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-16 h-16 shadow-lg flex items-center justify-center text-2xl z-50 touch-manipulation">
        ‚öôÔ∏è
      </button>

      <!-- Mobile Controls Modal -->
      <div id="mobileControlsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 sm:hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
          <!-- Close Button -->
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">Controls</h3>
            <button onclick="toggleMobileControls()" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
          </div>

          <!-- Timer Display -->
          <div class="bg-gray-100 rounded-lg p-4 mb-4 text-center">
            <div class="text-3xl font-mono font-bold text-gray-800 mb-3" id="freeformTimerMobile">00:00:00</div>
            <div class="flex flex-wrap justify-center gap-2">
              <button id="freeformStartBtnMobile" onclick="startFreeformTimer(); toggleMobileControls();" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition min-w-[100px] touch-manipulation">
                Start
              </button>
              <button id="freeformStopBtnMobile" onclick="stopFreeformTimer()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-lg transition min-w-[100px] touch-manipulation" disabled>
                Stop
              </button>
              <button onclick="resetFreeformTimer()" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-8 rounded-lg transition min-w-[100px] touch-manipulation">
                Reset
              </button>
            </div>
          </div>

          <!-- Brush Size -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <label class="block text-gray-700 font-semibold mb-3 text-center">Brush Size</label>
            <div class="flex items-center gap-3">
              <input type="range" id="brushSizeMobile" min="1" max="10" value="3" class="flex-1 h-8">
              <span id="brushSizeValueMobile" class="text-gray-700 font-mono font-bold text-xl min-w-[2ch] text-center">3</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-2 mb-2">
            <button onclick="saveCanvas(); toggleMobileControls();" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition touch-manipulation">
              Save
            </button>
            <button onclick="clearCanvas(); toggleMobileControls();" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-4 px-6 rounded-lg transition touch-manipulation">
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Setup -->
    <div id="quizSetup" class="hidden bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Quiz Setup</h2>
        <button onclick="backToMenu()" class="text-gray-600 hover:text-gray-800">‚Üê Back</button>
      </div>

      <div class="space-y-4">
        <!-- Number of Questions -->
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Number of Questions:</label>
          <input type="number" id="numQuestions" min="1" max="50" value="10" class="w-full border-2 border-gray-300 rounded-lg p-2">
        </div>

        <!-- Question Types -->
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Question Types:</label>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center space-x-2 p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" id="typeAddition" checked class="w-5 h-5">
              <span>‚ûï Addition</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" id="typeSubtraction" checked class="w-5 h-5">
              <span>‚ûñ Subtraction</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" id="typeMultiplication" checked class="w-5 h-5">
              <span>‚úñÔ∏è Multiplication</span>
            </label>
            <label class="flex items-center space-x-2 p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" id="typeDivision" checked class="w-5 h-5">
              <span>‚ûó Division</span>
            </label>
          </div>
        </div>

        <button onclick="startQuiz()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition">
          Start Quiz
        </button>
      </div>
    </div>

    <!-- Quiz Mode -->
    <div id="quizMode" class="hidden bg-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-800">Quiz in Progress</h2>
        <div class="text-xl font-mono font-bold text-indigo-600" id="quizTimer">00:00:00</div>
      </div>

      <!-- Progress -->
      <div class="mb-6">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span>Progress</span>
          <span id="progressText">0 / 0</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progressBar" class="bg-indigo-600 h-3 rounded-full transition-all" style="width: 0%"></div>
        </div>
      </div>

      <!-- Question -->
      <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-8 mb-6 text-center">
        <div class="text-5xl font-bold text-gray-800 mb-6" id="questionText">2 + 2 = ?</div>
        <input type="number" id="answerInput" class="text-3xl text-center border-4 border-indigo-300 rounded-lg p-4 w-48 focus:outline-none focus:border-indigo-600" placeholder="?">
      </div>

      <div class="flex space-x-4">
        <button onclick="submitAnswer()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition">
          Submit Answer
        </button>
        <button onclick="endQuiz()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition">
          End Quiz
        </button>
      </div>
    </div>

    <!-- Quiz Results -->
    <div id="quizResults" class="hidden bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Quiz Complete! üéâ</h2>
      
      <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 mb-6">
        <div class="grid grid-cols-2 gap-4 text-center">
          <div>
            <div class="text-gray-600 mb-1">Score</div>
            <div class="text-4xl font-bold text-indigo-600" id="finalScore">0/0</div>
          </div>
          <div>
            <div class="text-gray-600 mb-1">Time</div>
            <div class="text-4xl font-bold text-purple-600" id="finalTime">00:00</div>
          </div>
        </div>
      </div>

      <div class="space-y-2">
        <button onclick="backToMenu()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition">
          Back to Menu
        </button>
        <button onclick="showQuizSetup()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition">
          Try Again
        </button>
      </div>
    </div>
  </div>

  <script>
    // Generate falling numbers background
    function createFallingNumbers() {
      const container = document.getElementById('fallingNumbers');
      const numbers = '0123456789+-√ó√∑=';
      const numberOfElements = 30;
      
      for (let i = 0; i < numberOfElements; i++) {
        const numberElement = document.createElement('div');
        numberElement.className = 'number';
        numberElement.textContent = numbers[Math.floor(Math.random() * numbers.length)];
        
        // Random horizontal position
        numberElement.style.left = Math.random() * 100 + '%';
        
        // Random animation duration (8-15 seconds)
        const duration = 8 + Math.random() * 7;
        numberElement.style.animationDuration = duration + 's';
        
        // Random delay
        numberElement.style.animationDelay = Math.random() * 5 + 's';
        
        // Random size variation
        const size = 1.5 + Math.random() * 2;
        numberElement.style.fontSize = size + 'rem';
        
        // Random skew
        const skew = -20 + Math.random() * 40;
        numberElement.style.transform = `skewY(${skew}deg) rotate(${Math.random() * 30 - 15}deg)`;
        
        container.appendChild(numberElement);
      }
    }
    
    // Initialize falling numbers when page loads
    window.addEventListener('DOMContentLoaded', createFallingNumbers);
    
    // Freeform Mode Variables
    let freeformInterval = null;
    let freeformSeconds = 0;
    let isDrawingEnabled = false;
    let canvas, ctx;
    let isDrawing = false;

    // Quiz Mode Variables
    let quizInterval = null;
    let quizSeconds = 0;
    let questions = [];
    let currentQuestion = 0;
    let correctAnswers = 0;

    // Mobile Controls
    function toggleMobileControls() {
      const modal = document.getElementById('mobileControlsModal');
      modal.classList.toggle('hidden');
    }

    // Sync brush size between desktop and mobile
    function syncBrushSize(value) {
      ctx.lineWidth = value;
      document.getElementById('brushSizeValue').textContent = value;
      document.getElementById('brushSizeValueMobile').textContent = value;
      document.getElementById('brushSize').value = value;
      document.getElementById('brushSizeMobile').value = value;
    }

    function drawGrid() {
      const gridSize = 20; // Grid cell size in pixels
      ctx.save();
      ctx.strokeStyle = '#e5e7eb'; // Light gray color for grid
      ctx.lineWidth = 0.5;

      // Draw vertical lines
      for (let x = 0; x <= canvas.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }

      // Draw horizontal lines
      for (let y = 0; y <= canvas.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      ctx.restore();
    }

    // Initialize Canvas
    function initCanvas() {
      canvas = document.getElementById('freeformCanvas');
      ctx = canvas.getContext('2d');
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      // Resize canvas to fill container
      resizeCanvas();

      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);

      // Brush size sliders (sync both desktop and mobile)
      document.getElementById('brushSize').addEventListener('input', (e) => {
        syncBrushSize(e.target.value);
      });
      document.getElementById('brushSizeMobile').addEventListener('input', (e) => {
        syncBrushSize(e.target.value);
      });

      // Resize canvas when window resizes
      window.addEventListener('resize', resizeCanvas);
    }

    function resizeCanvas() {
      // Create temporary canvas to save current drawing
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, 0, 0);
      
      // Get container dimensions
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      
      // Set canvas dimensions to match container
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      // Restore context properties
      ctx.lineWidth = document.getElementById('brushSize').value || 3;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      
      // Draw grid first (covers entire new canvas)
      drawGrid();
      
      // Then restore drawing on top of grid using drawImage (preserves transparency)
      ctx.drawImage(tempCanvas, 0, 0);
    }

    function getScaledCoordinates(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    function startDrawing(e) {
      if (!isDrawingEnabled) return;
      isDrawing = true;
      const coords = getScaledCoordinates(e.clientX, e.clientY);
      ctx.beginPath();
      ctx.moveTo(coords.x, coords.y);
    }

    function draw(e) {
      if (!isDrawing || !isDrawingEnabled) return;
      const coords = getScaledCoordinates(e.clientX, e.clientY);
      ctx.lineTo(coords.x, coords.y);
      ctx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function handleTouch(e) {
      e.preventDefault();
      if (!isDrawingEnabled) return;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }


    function saveCanvas() {
      // Create a temporary canvas for the final image
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      
      // Draw the current canvas (with grid and drawings)
      tempCtx.drawImage(canvas, 0, 0);
      
      // Add timer value overlay
      const timerText = document.getElementById('freeformTimer').textContent;
      tempCtx.save();
      
      // Draw semi-transparent background for timer
      tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      tempCtx.fillRect(10, 10, 200, 60);
      
      // Draw timer text
      tempCtx.fillStyle = 'white';
      tempCtx.font = 'bold 32px monospace';
      tempCtx.fillText(timerText, 20, 50);
      
      tempCtx.restore();
      
      // Convert to blob and download
      tempCanvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        link.download = `math-practice-${timestamp}.png`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
      });
    }

    function clearCanvas() {
      // Check if there's any drawing on the canvas (beyond just the grid)
      if (hasDrawing()) {
        if (!confirm('Are you sure you want to clear the canvas? This cannot be undone.')) {
          return; // User cancelled, don't clear
        }
      }
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawGrid();
    }

    function hasDrawing() {
      // Create a temporary canvas with just the grid
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      
      // Draw grid on temp canvas
      const gridSize = 20;
      tempCtx.save();
      tempCtx.strokeStyle = '#e5e7eb';
      tempCtx.lineWidth = 0.5;
      
      for (let x = 0; x <= tempCanvas.width; x += gridSize) {
        tempCtx.beginPath();
        tempCtx.moveTo(x, 0);
        tempCtx.lineTo(x, tempCanvas.height);
        tempCtx.stroke();
      }
      
      for (let y = 0; y <= tempCanvas.height; y += gridSize) {
        tempCtx.beginPath();
        tempCtx.moveTo(0, y);
        tempCtx.lineTo(tempCanvas.width, y);
        tempCtx.stroke();
      }
      
      tempCtx.restore();
      
      // Compare current canvas with grid-only canvas
      const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      const gridData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height).data;
      
      // Check if there's any difference
      for (let i = 0; i < currentData.length; i++) {
        if (currentData[i] !== gridData[i]) {
          return true; // Found a difference, there's a drawing
        }
      }
      
      return false; // No drawing, just grid
    }

    // Navigation
    function showFreeform() {
      document.getElementById('appHeader').classList.add('hidden');
      document.getElementById('modeSelection').classList.add('hidden');
      document.getElementById('freeformMode').classList.remove('hidden');
      if (!canvas) initCanvas();
    }

    function showQuizSetup() {
      document.getElementById('modeSelection').classList.add('hidden');
      document.getElementById('quizSetup').classList.remove('hidden');
      document.getElementById('quizMode').classList.add('hidden');
      document.getElementById('quizResults').classList.add('hidden');
    }

    function backToMenu() {
      document.getElementById('appHeader').classList.remove('hidden');
      document.getElementById('modeSelection').classList.remove('hidden');
      document.getElementById('freeformMode').classList.add('hidden');
      document.getElementById('quizSetup').classList.add('hidden');
      document.getElementById('quizMode').classList.add('hidden');
      document.getElementById('quizResults').classList.add('hidden');
      
      // Reset timers
      stopFreeformTimer();
      resetFreeformTimer();
      if (quizInterval) clearInterval(quizInterval);
    }

    // Freeform Timer
    function startFreeformTimer() {
      if (freeformInterval) return;
      isDrawingEnabled = true;
      canvas.style.cursor = 'crosshair';
      document.getElementById('freeformStartBtn').disabled = true;
      document.getElementById('freeformStopBtn').disabled = false;
      document.getElementById('freeformStartBtnMobile').disabled = true;
      document.getElementById('freeformStopBtnMobile').disabled = false;
      
      // Show floating timer
      document.getElementById('floatingTimer').classList.remove('hidden');
      
      freeformInterval = setInterval(() => {
        freeformSeconds++;
        updateTimerDisplay('freeformTimer', freeformSeconds);
        updateTimerDisplay('freeformTimerMobile', freeformSeconds);
        updateTimerDisplay('floatingTimerDisplay', freeformSeconds);
      }, 1000);
    }

    function stopFreeformTimer() {
      if (!freeformInterval) return;
      clearInterval(freeformInterval);
      freeformInterval = null;
      isDrawingEnabled = false;
      canvas.style.cursor = 'not-allowed';
      document.getElementById('freeformStartBtn').disabled = false;
      document.getElementById('freeformStopBtn').disabled = true;
      document.getElementById('freeformStartBtnMobile').disabled = false;
      document.getElementById('freeformStopBtnMobile').disabled = true;
      
      // Hide floating timer
      document.getElementById('floatingTimer').classList.add('hidden');
    }

    function resetFreeformTimer() {
      stopFreeformTimer();
      freeformSeconds = 0;
      updateTimerDisplay('freeformTimer', 0);
      updateTimerDisplay('freeformTimerMobile', 0);
      updateTimerDisplay('floatingTimerDisplay', 0);
    }

    function updateTimerDisplay(elementId, seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      document.getElementById(elementId).textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Quiz Functions
    function startQuiz() {
      const numQuestions = parseInt(document.getElementById('numQuestions').value);
      const types = [];
      
      if (document.getElementById('typeAddition').checked) types.push('addition');
      if (document.getElementById('typeSubtraction').checked) types.push('subtraction');
      if (document.getElementById('typeMultiplication').checked) types.push('multiplication');
      if (document.getElementById('typeDivision').checked) types.push('division');

      if (types.length === 0) {
        alert('Please select at least one question type!');
        return;
      }

      // Generate questions
      questions = [];
      for (let i = 0; i < numQuestions; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        questions.push(generateQuestion(type));
      }

      currentQuestion = 0;
      correctAnswers = 0;
      quizSeconds = 0;

      document.getElementById('quizSetup').classList.add('hidden');
      document.getElementById('quizMode').classList.remove('hidden');

      // Start timer
      quizInterval = setInterval(() => {
        quizSeconds++;
        updateTimerDisplay('quizTimer', quizSeconds);
      }, 1000);

      showQuestion();
    }

    function generateQuestion(type) {
      let num1, num2, answer, question;

      switch(type) {
        case 'addition':
          num1 = Math.floor(Math.random() * 50) + 1;
          num2 = Math.floor(Math.random() * 50) + 1;
          answer = num1 + num2;
          question = `${num1} + ${num2} = ?`;
          break;
        case 'subtraction':
          num1 = Math.floor(Math.random() * 50) + 20;
          num2 = Math.floor(Math.random() * num1) + 1;
          answer = num1 - num2;
          question = `${num1} - ${num2} = ?`;
          break;
        case 'multiplication':
          num1 = Math.floor(Math.random() * 12) + 1;
          num2 = Math.floor(Math.random() * 12) + 1;
          answer = num1 * num2;
          question = `${num1} √ó ${num2} = ?`;
          break;
        case 'division':
          num2 = Math.floor(Math.random() * 10) + 2;
          answer = Math.floor(Math.random() * 10) + 1;
          num1 = num2 * answer;
          question = `${num1} √∑ ${num2} = ?`;
          break;
      }

      return { question, answer };
    }

    function showQuestion() {
      if (currentQuestion >= questions.length) {
        endQuiz();
        return;
      }

      const q = questions[currentQuestion];
      document.getElementById('questionText').textContent = q.question;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      
      // Update progress
      document.getElementById('progressText').textContent = `${currentQuestion + 1} / ${questions.length}`;
      const progress = ((currentQuestion + 1) / questions.length) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }

    function submitAnswer() {
      const userAnswer = parseInt(document.getElementById('answerInput').value);
      const correctAnswer = questions[currentQuestion].answer;

      if (userAnswer === correctAnswer) {
        correctAnswers++;
      }

      currentQuestion++;
      showQuestion();
    }

    function endQuiz() {
      clearInterval(quizInterval);
      quizInterval = null;

      document.getElementById('quizMode').classList.add('hidden');
      document.getElementById('quizResults').classList.remove('hidden');

      document.getElementById('finalScore').textContent = `${correctAnswers}/${questions.length}`;
      
      const minutes = Math.floor(quizSeconds / 60);
      const seconds = quizSeconds % 60;
      document.getElementById('finalTime').textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Allow Enter key to submit answer
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('answerInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitAnswer();
      });
    });
  </script>
</body>
</html>
